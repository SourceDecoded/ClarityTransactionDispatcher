{"version":3,"sources":["../src/ClarityTransactionDispatcher.js"],"names":["fs","uuid","resolvedPromise","Promise","resolve","ENTITIES_COLLECTION","SYSTEM_DATA_COLLECTION","NOTICE","defaultMongodbConfig","databaseName","ip","port","isBuiltIn","isInMemory","defaultConfig","mongodb","ClarityTransactionDispatcher","config","Object","assign","mongodbConfig","systems","services","entityQueue","Map","isInitialized","initializingPromise","mongoHelper","ObjectID","collectionName","item","modifiedDate","Date","createdDate","_getDatabaseAsync","then","db","collection","insertOne","result","_id","insertedId","Error","entity","components","forEach","component","filter","findOne","sort","pageSize","find","limit","parseInt","toArray","count","databaseUrl","connect","system","systemGuid","getGuid","_findOneAsync","systemData","newSystemData","_addItemToCollectionAsync","_invokeMethodAsync","_updateItemInCollectionAsync","catch","error","logError","message","obj","methodName","args","returnValue","apply","reduce","promise","deleteOne","update","_assertIsStarted","newEntity","revision","Array","isArray","_assignObjectIdsToComponents","_notifySystemsWithRecoveryAsync","validateEntityAsync","freeze","name","service","validateSystem","reject","push","_initializingSystemAsync","logMessage","type","getName","_notifySystemsAsync","deactivatedPromise","index","indexOf","splice","disposedPromise","lastId","lastModifiedDate","lastCreatedDate","$gt","_findAsync","notifySystemsPromises","entities","map","all","entityId","_getCountAsync","warning","_removeItemfromCollection","run","mongoBin","childProcess","kill","updatedEntity","oldEntity","toString","currentRevision"],"mappings":"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","file":"ClarityTransactionDispatcher.js","sourcesContent":["import * as fs from \"fs\";\nimport * as uuid from \"node-uuid\";\nimport { MongodHelper } from \"mongodb-prebuilt\";\nimport { MongoClient, ObjectID } from \"mongodb\";\n\nconst resolvedPromise = Promise.resolve(null);\n\nconst ENTITIES_COLLECTION = \"entities\";\nconst SYSTEM_DATA_COLLECTION = \"systemData\";\nconst NOTICE = \"notice\";\n\nconst defaultMongodbConfig = {\n    databaseName: \"clarity_transaction_dispatcher\",\n    ip: \"localhost\",\n    port: \"27017\",\n    isBuiltIn: true,\n    isInMemory: false\n};\n\nconst defaultConfig = {\n    mongodb: defaultMongodbConfig\n};\n\n/**\n * Class that organizes systems to respond to data transactions.\n * The dispatcher manages the life-cycle of data entities. They can be\n * added, updated, and removed. The dispatcher is not responsible\n * for anything beyond this. It will notify the systems when any entity \n * has been added, updated, and removed. This allows the dispatcher \n * to remain unopinionated about tasks to run when a certain entity is \n * added, updated, or removed.\n * \n * The idea behind the dispatcher is to handle the complexity of the IoT.\n * There are many systems, devices, and other technologies that need to \n * communicate for a company to run smoothly. We believe that the answer to \n * these needs is a data dispatcher which lets all independent systems know\n * about data changes.\n */\nexport default class ClarityTransactionDispatcher {\n\n    /**\n     * Create a Dispatcher.\n     * @constructor\n     * @param {object} config - {mongodb:{databaseName:string; ip:string; port:string; isBuildIn:boolean; isInMemory:boolean;}}.\n     */\n    constructor(config) {\n        config = Object.assign({}, defaultConfig, config);\n        this.mongodbConfig = Object.assign({}, defaultMongodbConfig, config.mongodb);\n\n        this.systems = [];\n        this.services = {};\n        this.entityQueue = new Map();\n        this.isInitialized = false;\n        this.initializingPromise = null;\n        this.mongoHelper = null;\n        this.ObjectID = ObjectID;\n    }\n\n    /**\n     * Add an item to a collection into mongodb.\n     * @private \n     * @param {string} collectionName - The mongodb collection name.\n     * @param {object} item - The item to be added.\n     */\n    _addItemToCollectionAsync(collectionName, item) {\n        item.modifiedDate = new Date();\n        item.createdDate = new Date();\n        return this._getDatabaseAsync().then((db) => {\n            return db.collection(collectionName);\n        }).then((collection) => {\n            return collection.insertOne(item);\n        }).then((result) => {\n            item._id = result.insertedId;\n            return item;\n        });\n    }\n\n    /**\n     * Ensures the mongodb is ready by asserting that it has been successfully started.\n     */\n    _assertIsStarted() {\n        if (!this.isInitialized) {\n            throw new Error(\"The dispatcher needs to be started before calling any other method.\");\n        }\n    }\n\n    /**\n     * \n     * @param {IEntity} entity - The entity to manage component id's to. \n     */\n    _assignObjectIdsToComponents(entity) {\n        entity.components.forEach(component => {\n            if (!component._id) {\n                component._id = this.ObjectID();\n            } else {\n                component._id = this.ObjectID(component._id);\n            }\n        });\n    }\n\n    /** \n     * Find one in a collection.\n     * @private\n     */\n    _findOneAsync(collectionName, filter) {\n        return this._getDatabaseAsync().then((db) => {\n            return db.collection(collectionName);\n        }).then((collection) => {\n            return collection.findOne(filter);\n        });\n    }\n\n    /** \n    * Find many in a collection.\n    * @private\n    */\n    _findAsync(collectionName, filter, sort, pageSize) {\n        return this._getDatabaseAsync().then((db) => {\n            return db.collection(collectionName);\n        }).then((collection) => {\n            return collection.find(filter).limit(parseInt(pageSize, 10)).sort(sort).toArray();\n        });\n    }\n\n    /** \n     * Get count in a collection.\n     * @private\n     */\n    _getCountAsync(collectionName) {\n        return this._getDatabaseAsync().then((db) => {\n            return db.collection(collectionName);\n        }).then((collection) => {\n            return collection.count();\n        });\n    }\n\n    /**\n     * Get a mongodb.\n     * @private\n     * @returns {Promise<mongodb>}\n     */\n    _getDatabaseAsync() {\n        var databaseName = this.mongodbConfig.isInMemory ? this.mongodbConfig.databaseName + \"_in_memory\" : this.mongodbConfig.databaseName;\n        var databaseUrl = `mongodb://${this.mongodbConfig.ip}:${this.mongodbConfig.port}/${databaseName}`;\n\n        return MongoClient.connect(databaseUrl);\n    }\n\n    /**\n     * Initialize a system.\n     * @private\n     */\n    _initializingSystemAsync(system) {\n        let systemGuid = system.getGuid();\n\n        let filter = {\n            systemGuid\n        };\n\n        return this._findOneAsync(SYSTEM_DATA_COLLECTION, filter).then((systemData) => {\n            if (systemData == null) {\n                let newSystemData = {\n                    systemGuid,\n                    isInitialized: false\n                };\n\n                return this._addItemToCollectionAsync(SYSTEM_DATA_COLLECTION, newSystemData);\n            } else {\n                return systemData;\n            }\n        }).then((systemData) => {\n            if (!systemData.isInitialized) {\n                return this._invokeMethodAsync(system, \"initializeAsync\", [this]).then(() => {\n                    systemData.isInitialized = true;\n                    return this._updateItemInCollectionAsync(SYSTEM_DATA_COLLECTION, systemData);\n                });\n            }\n        }).catch((error) => {\n            this.logError({ message: error.message });\n            throw error;\n        });\n    }\n\n    /**\n     * Invoke a method on any object and make sure a promise is the returned value.\n     * @private\n     */\n    _invokeMethodAsync(obj, methodName, args) {\n        var returnValue;\n\n        if (typeof obj[methodName] === \"function\") {\n            returnValue = obj[methodName].apply(obj, args);\n            if (!(returnValue instanceof Promise)) {\n                returnValue = Promise.resolve(returnValue);\n            }\n        } else {\n            returnValue = resolvedPromise;\n        }\n\n        return returnValue;\n    }\n\n    /**\n     * Notify the systems of a life cycle by its method name.\n     * @private\n     * @returns {Promise<undefined>}\n     */\n    _notifySystemsAsync(methodName, args) {\n        return this.systems.reduce((promise, system) => {\n\n            return promise.then(() => {\n\n                try {\n                    return this._invokeMethodAsync(system, methodName, args);\n                } catch (error) {\n                    this.logError(error);\n                    throw error;\n                }\n\n            });\n\n        }, resolvedPromise);\n    }\n\n    /**\n       * Notify the systems of a life cycle by its method name and recover if \n       * any of the systems reject the promise.\n       * \n       * This will be used for most life-cycle calls. The other systems need to respond \n       * regardless of other systems failing.\n       * @private\n       * @returns {Promise<undefined>}\n       */\n    _notifySystemsWithRecoveryAsync(methodName, args) {\n        return this.systems.reduce((promise, system) => {\n\n            return promise.then(() => {\n\n                try {\n                    return this._invokeMethodAsync(system, methodName, args);\n                } catch (error) {\n                    this.logError(error);\n                    throw error;\n                }\n\n            }).catch(() => {\n                return resolvedPromise;\n            });\n\n        }, resolvedPromise);\n    }\n\n    /**\n     * Remove an item from a collection.\n     * @private\n     * @returns {Promise<undefined>}\n     */\n    _removeItemfromCollection(collectionName, item) {\n        return this._getDatabaseAsync().then((db) => {\n            return db.collection(collectionName);\n        }).then((collection) => {\n            return collection.deleteOne({\n                _id: this.ObjectID(item._id)\n            });\n        });\n    }\n\n    /**\n     * Update an item in a collection.\n     * @private\n     * @returns {Promise<undefined>}\n     */\n    _updateItemInCollectionAsync(collectionName, item) {\n        item.modifiedDate = new Date();\n        return this._getDatabaseAsync().then((db) => {\n            return db.collection(collectionName);\n        }).then((collection) => {\n            return collection.update({\n                _id: this.ObjectID(item._id)\n            }, item, null);\n        });\n    }\n\n    /**\n     * Add an Entity to the datastore. The steps the dispatcher takes when saving an\n     * entity are.\n     * \n     * - Have the Systems prepare the entity to be inserted with prepareEntityToBeAddedAsync.\n     * - Validate the entity with all systems. All systems have to validate to pass.\n     * - Save the entity to the datastore.\n     * - Notify the systems that an entity has been added with entityAddedAsync.\n     * @param {IEntity} entity - The entity that you want to save to the datastore.\n     * @return {Promise<Entity>}\n     */\n    addEntityAsync(entity) {\n        this._assertIsStarted();\n\n        let newEntity = {\n            _id: entity._id ? this.ObjectID(entity._id) : this.ObjectID(),\n            revision: this.ObjectID(),\n            components: Array.isArray(entity.components) ? entity.components : []\n        };\n\n        this._assignObjectIdsToComponents(newEntity);\n\n        return this._notifySystemsWithRecoveryAsync(\"prepareEntityToBeAddedAsync\", [newEntity]).then(() => {\n            this.validateEntityAsync(newEntity);\n        }).then(() => {\n            return this._addItemToCollectionAsync(ENTITIES_COLLECTION, newEntity);\n        }).then(entity => {\n            return this._notifySystemsWithRecoveryAsync(\"entityAddedAsync\", [Object.freeze(entity)]).then(() => {\n                return entity;\n            });\n        }).catch(error => {\n            this.logError(error);\n            throw error;\n        });\n    }\n\n    /**\n     * Add a service for systems to use. Services could be HTTP services,\n     * or governance that needs to be shared acrossed systems.\n     * @param {string} name - The name by which the systems will request the service.\n     * @param {object} service - The service.\n     * @return {Promise<undefined>}\n     */\n    addServiceAsync(name, service) {\n        this._assertIsStarted();\n\n        this.services[name] = service;\n        return resolvedPromise;\n    }\n\n    /**\n     * Add a system to the dispatcher. The systems are really where the work \n     * is done. They listen to the life-cycle of the entity and react based\n     * on the composition of components.\n     * The dispatcher does the following when adding a system.\n     * \n     * - Adds the system.\n     * - Invokes initializeAsync if the system hasn't been initialized before.\n     * - Invokes activatedAsync after initializeAsync is finished.\n     * \n     * #### Required System Methods\n     * - getGuid()\n     * - getName()\n     * \n     * #### Optional System Methods\n     *  - activatedAsync(clarityTransactionDispatcher: ClarityTransactionDispatcher)\n     *  - approveEntityRemovalAsync(entity: IEntity)\n     *  - deactivatedAsync()\n     *  - disposedAsync()\n     *  - entityAddedAsync(entity: IEntity)\n     *  - entityRemovedAsync(entity: IEntity)\n     *  - entityRetrievedAsync(entity: IEntity)\n     *  - entityUpdatedAsync(oldEntity: IEntity, updatedEntity: IEntity)\n     *  - initializeAsync(clarityTransactionDispatcher: ClarityTransactionDispatcher)\n     *  - logError(error: { type?: string; message?: string; })\n     *  - logMessage(message: { type?: string; message?: string; })\n     *  - logWarning(warning: { type?: string; message?: string; })\n     *  - prepareEntityToBeAddedAsync(enitty: IEntity)\n     *  - prepareEntityToBeUpdatedAsync(oldEntity: IEntity, entity: IEntity)\n     *  - serviceRemovedAsync(name: string)\n     *  - validateEntityAsync(entity: IEntity)\n     * @param {ISystem} system - The system to add.\n     * @return {Promise} - An undefined Promise.\n     */\n    addSystemAsync(system) {\n        this._assertIsStarted();\n\n        if (!this.validateSystem(system)) {\n            return Promise.reject(new Error(\"Invalid system: Systems need to have a getName and a getGuid method on them.\"));\n        } else {\n            this.systems.push(system);\n            return this._initializingSystemAsync(system).then(() => {\n                this.logMessage({\n                    type: NOTICE,\n                    message: `System \"${system.getName()}\" was initialized.`\n                });\n\n                return this._invokeMethodAsync(system, \"activatedAsync\", [this]);\n            }).then(() => {\n                this.logMessage({\n                    type: NOTICE,\n                    message: `System \"${system.getName()}\" was activated.`\n                });\n            }).catch(error => {\n                this.logError(error);\n                throw error;\n            });\n        }\n    }\n\n    /**\n   * Approves whether an entity can be removed. Systems can deny the ability to remove entities.\n   * @param entity {object} - The entity to be removed.\n   */\n    approveEntityRemovalAsync(entity) {\n        this._assertIsStarted();\n\n        return this._notifySystemsAsync(\"approveEntityRemovalAsync\", [entity]);\n    }\n\n    /**\n     * Deactivates a system and removes it from the systems being notified. To activate again use addSystemAsync.\n     * Think of this like a pause. The dispatcher calls deactivatedAsync on the system being removed.\n     * @param {ISystem} system - The system to be deactivate.\n     * @returns {Promise<undefined>} - Resolves when the system is deactivated.\n     */\n    deactivateSystemAsync(system) {\n        this._assertIsStarted();\n\n        let deactivatedPromise;\n        let index = this.systems.indexOf(system);\n\n        if (index === -1) {\n            return Promise.reject(new Error(\"Couldn't find system to be deactivated.\"));\n        } else {\n\n            this.systems.splice(index, 1);\n\n            try {\n                return deactivatedPromise = this._invokeMethodAsync(system, \"deactivatedAsync\", []).then(() => {\n                    this.logMessage({\n                        type: NOTICE,\n                        message: `System \"${system.getName()}\" was deactivated.`\n                    });\n                }).catch(() => {\n                    return resolvedPromise;\n                });\n            } catch (error) {\n                return resolvedPromise;\n            }\n        }\n    }\n\n    /**\n     * Disposes a system and removes it from the systems being notified. Use when removing systems for\n     * good. This allows the system to clean up after itself if needed. The dispatcher calls disposeAsync on the system being removed.\n     * @param {ISystem} system - The system to be disposed.\n     * @returns {Promise<undefined>} - Resolves when the system is disposed.\n     */\n    disposeSystemAsync(system) {\n        this._assertIsStarted();\n\n        var disposedPromise;\n        var index = this.systems.indexOf(system);\n\n        if (index === -1) {\n            return Promise.reject(new Error(\"Couldn't find system to be disposed.\"));\n        } else {\n\n            this.systems.splice(index, 1);\n\n            try {\n                return disposedPromise = this._invokeMethodAsync(system, \"disposedAsync\", []).then(() => {\n                    this.logMessage({\n                        type: NOTICE,\n                        message: `System \"${system.getName()}\" was disposed.`\n                    });\n                }).catch(() => {\n                    return resolvedPromise;\n                });\n            } catch (error) {\n                return resolvedPromise;\n            }\n        }\n    }\n\n    /**\n     * Page through entities using the lastId from a previous query. Use null or undefined to begin at the beginning.\n     * @param config {} - The configuration of the query. It takes a lastId, pageSize, lastModifiedDate, and a lastCreatedDate. \n     */\n    getEntitiesAsync(config) {\n        this._assertIsStarted();\n\n        let lastId = config.lastId ? this.ObjectID(config.lastId) : null;\n        let pageSize = config.pageSize < 50 ? config.pageSize : 50;\n        let lastModifiedDate = config.lastModifiedDate;\n        let lastCreatedDate = config.lastCreatedDate;\n\n        let sort = [[\"_id\", 1]];\n        let filter = {};\n\n        if (lastId != null) {\n            filter._id = {\n                $gt: lastId\n            };\n        }\n\n        if (lastCreatedDate != null) {\n            filter.createdDate = {\n                $gt: lastCreatedDate\n            };\n            sort.push([\"createdDate\", 1]);\n        }\n\n        if (lastModifiedDate != null) {\n            filter.modifiedDate = {\n                $gt: lastModifiedDate\n            };\n            sort.push([\"modifiedDate\", 1]);\n        }\n\n        return this._findAsync(ENTITIES_COLLECTION, filter, sort, pageSize).then(entities => {\n            let notifySystemsPromises = entities.map(entity => {\n                return this._notifySystemsWithRecoveryAsync(\"entityRetrievedAsync\", [entity]);\n            });\n\n            return Promise.all(notifySystemsPromises).then(() => {\n                return entities;\n            });\n        }).catch(error => {\n            this.logError(error);\n            throw error;\n        });\n    }\n\n    /**\n     * Get an entity by its id.\n     * @param {string} entityId - The id of the desired entity.\n     * @return {Promise<Entity>} - A Promise resolved with the entity or null.\n     */\n    getEntityByIdAsync(entityId) {\n        this._assertIsStarted();\n\n        return this._findOneAsync(ENTITIES_COLLECTION, {\n            _id: this.ObjectID(entityId)\n        }).then(entity => {\n            return this._notifySystemsWithRecoveryAsync(\"entityRetrievedAsync\", [entity]).then(() => {\n                return entity;\n            });\n        }).catch((error) => {\n            this.logError(error);\n            throw error;\n        });\n    }\n\n    /**\n     * Get count for all entities in collection.\n     */\n    getEntityCountAsync() {\n        this._assertIsStarted();\n\n        return this._getCountAsync(ENTITIES_COLLECTION);\n    }\n\n    /**\n     * Get a service by the name given.\n     * @param {string} name - The name of the desired service.\n     * @returns {object} - Null or the desired service.\n     */\n    getService(name) {\n        this._assertIsStarted();\n\n        return this.services[name] || null;\n    }\n\n    /**\n     * Get all systems.\n     * @returns {Array<ISystems>}\n     */\n    getSystems() {\n        this._assertIsStarted();\n\n        return this.systems;\n    }\n\n    /**\n     * Notifies the systems about an error.\n     * @param error {object} - The error to be sent to the systems.\n     * @returns {undefined}\n     */\n    logError(error) {\n        this._assertIsStarted();\n\n        this._notifySystemsAsync(\"logError\", [error]);\n    }\n\n    /**\n     * Notifies the systems about a message.\n     * @param message {object} - The message to be sent to the systems.\n     * @returns {undefined}\n     */\n    logMessage(message) {\n        this._assertIsStarted();\n\n        this._notifySystemsAsync(\"logMessage\", [message]);\n    }\n\n    /**\n     * Notifies the systems about a warning.\n     * @param warning {object} - The warning to be sent to the systems.\n     * @returns {undefined}\n     */\n    logWarning(warning) {\n        this._assertIsStarted();\n\n        this._notifySystemsAsync(\"logWarning\", [warning]);\n    }\n\n    /**\n     * Removes the entity to be removed and notifies the systems the entity has been removed.\n     * @param {IEntity} entity - The entity to be removed.\n     * @returns {Promise<undefined>} \n     */\n    removeEntityAsync(entity) {\n        this._assertIsStarted();\n\n        return this._removeItemfromCollection(ENTITIES_COLLECTION, entity).then(() => {\n            return this._notifySystemsWithRecoveryAsync(\"entityRemovedAsync\", [Object.freeze(entity)]);\n        }).then(() => {\n            return entity;\n        }).catch(error => {\n            this.logError(error);\n            throw error;\n        });\n    }\n\n    /**\n     * Removes a service by its name. The dispatcher will notify the systems that this service is being \n     * removed.\n     * @param {string} name - The name of the service to be removed.\n     * @returns {undefined}\n     */\n    removeServiceAsync(name) {\n        this._assertIsStarted();\n\n        if (this.services[name]) {\n            delete this.services[name];\n            return this._notifySystemsWithRecoveryAsync(\"serviceRemovedAsync\", [name]);\n        } else {\n            var error = Error(\"Couldn't find service to be removed.\");\n            this.logError(error);\n            return Promise.reject(error);\n        }\n    }\n\n    /**\n     * Starts the database.\n     */\n    startAsync() {\n        if (this.initializingPromise != null) {\n            return this.initializingPromise;\n        } else {\n            this.mongoHelper = new MongodHelper([\"--port\", this.mongodbConfig.port, \"--dbpath\", \"/data/db\"]);\n\n            return this.initializingPromise = this.mongoHelper.run().then(() => {\n                this.isInitialized = true;\n            }).catch((error) => {\n\n            });\n        }\n    }\n\n    /**\n     * Stops the database. This will deactivate all the systems so they know that they are about \n     * to be turned off. This will allow the systems to turn off processes gracefully that they \n     * manage.\n     */\n    stopAsync() {\n        var initializingPromise = this.initializingPromise;\n\n        if (this.initializingPromise == null) {\n            initializingPromise = resolvedPromise;\n        }\n\n        return initializingPromise.then(() => {\n            return this._notifySystemsWithRecoveryAsync(\"deactivatedAsync\", []);\n        }).then(() => {\n            this.mongoHelper.mongoBin.childProcess.kill();\n        });\n    }\n\n    /**\n     * Update an entity. The dispatcher will perform the following actions when updating.\n     * \n     * - Validate the entity. All interested systems need to validate to pass.\n     * - Entity's updates are saved.\n     * - The systems are notified about the update.\n     * @param {object} entity - The updated entity.\n     * @returns {Promise<undefined>} - Resolves when the entity is saved.\n     */\n    updateEntityAsync(entity) {\n        let updatedEntity = {\n            _id: entity._id ? this.ObjectID(entity._id) : this.ObjectID,\n            revision: this.ObjectID(entity.revision),\n            components: Array.isArray(entity.components) ? entity.components : []\n        };\n\n        this._assignObjectIdsToComponents(updatedEntity);\n\n        return this._findOneAsync(ENTITIES_COLLECTION, {\n            _id: updatedEntity._id\n        }).then((oldEntity) => {\n            return this._notifySystemsWithRecoveryAsync(\"prepareEntityToBeUpdatedAsync\", [oldEntity, updatedEntity]).then(() => {\n                return this.validateEntityAsync(updatedEntity);\n            }).then(() => {\n                return oldEntity;\n            });\n        }).then((oldEntity) => {\n\n            if (oldEntity.revision.toString() !== updatedEntity.revision.toString()) {\n                var error = new Error(\"Entity out of date.\");\n                error.name = \"OutOfDate\";\n                error.currentRevision = oldEntity;\n\n                throw error;\n            }\n\n            updatedEntity._id = oldEntity._id;\n            updatedEntity.revision = this.ObjectID();\n            updatedEntity.createdDate = oldEntity.createdDate;\n\n            return this._updateItemInCollectionAsync(ENTITIES_COLLECTION, updatedEntity).then((oldEntity) => {\n                return this._notifySystemsWithRecoveryAsync(\"entityUpdatedAsync\", [oldEntity, Object.freeze(updatedEntity)]);\n            }).then(() => {\n                return updatedEntity;\n            });\n\n        }).catch((error) => {\n            this.logError(error);\n            throw error;\n        });\n\n    }\n\n    /**\n     * This allows systems to validate the entity being saved.\n     */\n    validateEntityAsync(entity) {\n        return this._notifySystemsAsync(\"validateEntityAsync\", [entity]);\n    }\n\n    /**\n     * Ensures the system has the required methods.\n     * @param {ISystem} system - The System to be validated.\n     */\n    validateSystem(system) {\n        if (typeof system.getGuid !== \"function\" ||\n            typeof system.getName !== \"function\") {\n            return false;\n        }\n\n        return true;\n    }\n}"]}