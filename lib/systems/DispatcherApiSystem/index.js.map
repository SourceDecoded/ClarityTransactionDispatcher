{"version":3,"sources":["../../../src/systems/DispatcherApiSystem/index.js"],"names":["DispatcherApiSystem","clarityTransactionDispatcher","app","guid","name","authenticator","fileSystem","router","init","getService","_initAPI","entityId","component","getEntityByIdAsync","then","entity","components","push","updateEntityAsync","Promise","resolve","updatedEntity","slice","file","fileId","ObjectID","getFileWriteStreamByIdAsync","reject","contentLength","on","data","length","error","pipe","writeStream","id","componentId","getComponentsByEntityIdAsync","filter","_id","Error","removedComponent","componentIndex","findIndex","splice","removeEntityAsync","originalEntity","createdDate","Object","assign","newEntity","newComponent","getComponentAsync","oldComponent"],"mappings":"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","file":"index.js","sourcesContent":["import Router from \"./app/Router\";\n\nexport default class DispatcherApiSystem {\n    constructor() {\n        this.clarityTransactionDispatcher = null;\n        this.app = null;\n        this.guid = \"13CE560D-9B85-4C85-8BA4-72EA1686EBAA\";\n        this.name = \"Dispatcher Api System\";\n        this.authenticator = null;\n        this.fileSystem = null;\n    }\n\n     _initAPI() {\n        const router = new Router(this);\n        router.init();\n    }\n\n    activatedAsync(clarityTransactionDispatcher) {\n        this.clarityTransactionDispatcher = clarityTransactionDispatcher;\n        this.fileSystem = this.clarityTransactionDispatcher.getService(\"fileSystem\");\n        this._initAPI();\n    }\n\n    addComponentAsync(entityId, component) {\n        return this.clarityTransactionDispatcher.getEntityByIdAsync(entityId).then(entity => {\n            entity.components.push(component);\n            return this.clarityTransactionDispatcher.updateEntityAsync(entity);\n        }).then(updatedEntity => {\n            return Promise.resolve(updatedEntity.components.slice(-1)[0]);\n        });\n    }\n\n    addFileAsync(file) {\n        const fileId = this.clarityTransactionDispatcher.ObjectID();\n\n        return this.fileSystem.getFileWriteStreamByIdAsync(fileId).then(writeStream => {\n            return new Promise((resolve, reject) => {\n                let contentLength = 0;\n\n                file.on(\"data\", data => {\n                    contentLength += data.length;\n                });\n\n                file.on(\"end\", () => {\n                    resolve({ contentLength, fileId });\n                });\n\n                file.on(\"error\", error => {\n                    reject(error);\n                });\n\n                file.pipe(writeStream);\n            });\n        });\n    }\n\n    getGuid() {\n        return this.guid;\n    }\n\n    getName() {\n        return this.name;\n    }\n\n    getComponentsByEntityIdAsync(id) {\n        return this.clarityTransactionDispatcher.getEntityByIdAsync(id).then(entity => {\n            return Promise.resolve(entity.components);\n        });\n    }\n\n    getComponentAsync(componentId, entityId) {\n        return this.getComponentsByEntityIdAsync(entityId).then(components => {\n            const component = components.filter(component => component._id == componentId)[0];\n\n            if (component) {\n                return Promise.resolve(component);\n            } else {\n                return Promise.reject(new Error(\"The entity provided does not have a component with that id.\"));\n            }\n        });\n    }\n\n    removeComponentAsync(componentId, entityId) {\n        let removedComponent;\n\n        return this.clarityTransactionDispatcher.getEntityByIdAsync(entityId).then(entity => {\n            const componentIndex = entity.components.findIndex(component => component._id == componentId);\n\n            if (componentIndex !== -1) {\n                removedComponent = entity.components.splice(componentIndex, 1);\n            } else {\n                return Promise.reject(new Error(\"The entity provided does not have a component with that id.\"));\n            }\n\n            return this.clarityTransactionDispatcher.updateEntityAsync(entity);\n        }).then(() => {\n            return Promise.resolve(removedComponent);\n        });\n    }\n\n    removeEntityByIdAsync(id) {\n        return this.clarityTransactionDispatcher.getEntityByIdAsync(id).then(entity => {\n            return this.clarityTransactionDispatcher.removeEntityAsync(entity);\n        });\n    }\n\n    updateEntityAsync(entityId, entity) {\n        return this.clarityTransactionDispatcher.getEntityByIdAsync(entityId).then(originalEntity => {\n            entity._id = originalEntity._id;\n            entity.createdDate = originalEntity.createdDate;\n            return Object.assign({}, originalEntity, entity);\n        }).then(newEntity => {\n            return this.clarityTransactionDispatcher.updateEntityAsync(newEntity);\n        });\n    }\n\n    updateComponentAsync(componentId, entityId, component) {\n        let newComponent;\n\n        return this.getComponentAsync(componentId, entityId).then(oldComponent => {\n            component._id = oldComponent._id;\n            newComponent = Object.assign({}, oldComponent, component);\n\n            return this.clarityTransactionDispatcher.getEntityByIdAsync(entityId);\n        }).then(entity => {\n            const componentIndex = entity.components.findIndex(component => component._id == componentId);\n            entity.components[componentIndex] = newComponent;\n\n            return this.clarityTransactionDispatcher.updateEntityAsync(entity);\n        }).then(updatedEntity => {\n            return this.getComponentAsync(componentId, entityId);\n        });\n    }\n}"]}